# 更新日志 (Changelog)

本文档记录 Quant-GRU-PyTorch 项目的所有重要更新和变更。

---

## [2026-01-26]

### Bug 修复
1. 修复反向时将被 clamp 的值也传入梯度的 bug
2. 修复反向计算梯度时使用 TF32 类型导致梯度精度太低的 bug

### 功能优化
1. 通过将 `roundf` 函数改为和 PyTorch 使用四舍五入逻辑相同的 `rintf` 函数来提升 PTQ 精度
2. **乘法 scale 融合优化**：将乘法操作（如 `reset_gate * weight_hh_linear`、`update_gate * h_old` 等）的结果直接对齐到目标量化 scale，省略了中间的量化步骤。该优化减少了量化误差累积（每次量化都会引入舍入误差，省略中间量化减少了一次舍入误差），提高了数值精度，同时减少了计算开销和参数管理复杂度

---

## [2026-01-15]

### 新功能
1. **量化参数导入导出**: 支持量化参数的导入和导出功能
2. **手动调整导出位宽**: 支持手动调整导出的量化参数位宽
3. **外部控制符号类型**: 支持算子位宽是 UINT 还是 INT 可以在外部 (JSON) 控制

### Bug 修复
- 修复校验时是否对称量化与是否有符号量化绑定的 bug

---

## [2025-01-13]

### 功能优化
1. **量化计算流程重构**: 从原来的在一个大 kernel 中进行 bias 的累加，改为在线性层同时进行 GEMM 和 bias 的相加，以保持与编译器和硬件实现一致
2. **统一量化参数命名格式**: 规范化量化参数的命名规则，提高代码可读性和维护性

---

## [2025-01-08]

### 新功能
1. **量化参数导入导出**: 支持量化参数的导入和导出功能
2. **手动调整导出位宽**: 支持手动调整导出的量化参数位宽
3. **外部控制符号类型**: 支持算子位宽是 UINT 还是 INT 可以在外部 (JSON) 控制

### Bug 修复
- 修复校验时是否对称量化与有符号量化绑定的 bug

---

## [2025-01-07]

### 新功能
1. **任意位宽支持**: 所有算子支持任意 bit 位宽设置

### Bug 修复
1. 修复分段拟合表全局共享导致多个 GRU 情况下 PTQ 精度下降的 bug
2. 修复校验时第一个时间步没有正确初始化的 bug
3. 修复直方图在边缘情况下的处理情况与 AIMET 实现不一致的 bug

### 性能优化
- 优化各个校验方法的速度

---

## [2024-12-31]

### 新功能
1. **灵活位宽配置**: 
   - 支持激活函数输入和输出位宽不一致
   - 支持权重和输入位宽不一致
2. **ONNX 浮点导出**: 支持 ONNX 浮点格式导出
3. **校准截断控制**: 支持校准时用截断比例控制
4. **C++ 定点 GRU 实现**: 实现 C++ 版本的纯定点 GRU 用于 Reference Model 验证

### 功能优化
- **校验流程优化**: 原来不能在 Forward 的时候同时进行校验，必须单独跑校验函数；现已优化支持同时进行

### Bug 修复
1. 修复混合精度配置下中间结果移除导致精度下降的 bug
2. 修复使用双向 GRU 时分段拟合表不匹配的 bug
3. 修复 QDQ 导出时，算子位宽与配置不匹配的 bug

---

## 版本说明

- 日期格式: `YYYY-MM-DD`
- 更新类型:
  - **新功能**: 新增的功能特性
  - **功能优化**: 对现有功能的改进和优化
  - **Bug 修复**: 修复的问题和错误
  - **性能优化**: 性能相关的改进
  - **破坏性变更**: 不向后兼容的变更（如有）
